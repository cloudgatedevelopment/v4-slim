{"version":3,"sources":["index.js"],"names":["require","Plugin","cuid","Translator","Provider","RequestClient","Socket","emitSocketProgress","getSocketHost","settle","EventTracker","ProgressTimeout","RateLimitedQueue","NetworkError","isNetworkError","buildResponseError","xhr","error","Error","data","request","setTypeInBlob","file","dataWithUpdatedType","slice","size","meta","type","module","exports","uppy","opts","id","title","defaultLocale","strings","timedOut","defaultOptions","formData","fieldName","method","metaFields","responseUrlFieldName","bundle","headers","timeout","limit","withCredentials","responseType","getResponseData","responseText","response","parsedResponse","JSON","parse","err","console","log","getResponseError","validateStatus","status","i18nInit","handleUpload","bind","__queue","requests","uploaderEvents","Object","create","setOptions","newOpts","translator","locale","i18n","translate","setPluginState","getOptions","overrides","getState","xhrUpload","addMetadata","Array","isArray","keys","forEach","item","append","createFormDataUpload","formPost","FormData","name","createBundledUpload","files","createBareUpload","upload","current","total","Promise","resolve","reject","emit","XMLHttpRequest","timer","abort","queuedRequest","done","seconds","Math","ceil","addEventListener","ev","loaded","progress","lengthComputable","uploader","bytesUploaded","bytesTotal","remove","target","body","uploadURL","uploadResp","open","toUpperCase","endpoint","header","setRequestHeader","run","send","onFileRemove","onCancelAll","uploadRemote","fields","Client","remote","providerOptions","provider","client","post","url","fieldname","metadata","httpMethod","useFormData","then","res","token","host","companionUrl","socket","autoOpen","onRetry","onRetryAll","on","progressData","errData","resp","message","cause","isPaused","close","catch","uploadBundle","optsFromState","emitError","uploadFiles","promises","map","i","parseInt","length","isRemote","fileID","cb","targetFileID","filesToRetry","getFile","fileIDs","isSomeFileRemote","some","install","capabilities","setState","individualCancellation","addUploader","uninstall","removeUploader","VERSION"],"mappings":";;;;;;;;eAAmBA,OAAO,CAAC,YAAD,C;IAAlBC,M,YAAAA,M;;AACR,IAAMC,IAAI,GAAGF,OAAO,CAAC,MAAD,CAApB;;AACA,IAAMG,UAAU,GAAGH,OAAO,CAAC,4BAAD,CAA1B;;gBAC4CA,OAAO,CAAC,wBAAD,C;IAA3CI,Q,aAAAA,Q;IAAUC,a,aAAAA,a;IAAeC,M,aAAAA,M;;AACjC,IAAMC,kBAAkB,GAAGP,OAAO,CAAC,oCAAD,CAAlC;;AACA,IAAMQ,aAAa,GAAGR,OAAO,CAAC,+BAAD,CAA7B;;AACA,IAAMS,MAAM,GAAGT,OAAO,CAAC,wBAAD,CAAtB;;AACA,IAAMU,YAAY,GAAGV,OAAO,CAAC,8BAAD,CAA5B;;AACA,IAAMW,eAAe,GAAGX,OAAO,CAAC,iCAAD,CAA/B;;AACA,IAAMY,gBAAgB,GAAGZ,OAAO,CAAC,kCAAD,CAAhC;;AACA,IAAMa,YAAY,GAAGb,OAAO,CAAC,8BAAD,CAA5B;;AACA,IAAMc,cAAc,GAAGd,OAAO,CAAC,gCAAD,CAA9B;;AAEA,SAASe,kBAAT,CAA6BC,GAA7B,EAAkCC,KAAlC,EAAyC;AACvC;AACA,MAAI,CAACA,KAAL,EAAYA,KAAK,GAAG,IAAIC,KAAJ,CAAU,cAAV,CAAR,CAF2B,CAGvC;;AACA,MAAI,OAAOD,KAAP,KAAiB,QAArB,EAA+BA,KAAK,GAAG,IAAIC,KAAJ,CAAUD,KAAV,CAAR,CAJQ,CAKvC;;AACA,MAAI,EAAEA,KAAK,YAAYC,KAAnB,CAAJ,EAA+B;AAC7BD,IAAAA,KAAK,GAAG,SAAc,IAAIC,KAAJ,CAAU,cAAV,CAAd,EAAyC;AAAEC,MAAAA,IAAI,EAAEF;AAAR,KAAzC,CAAR;AACD;;AAED,MAAIH,cAAc,CAACE,GAAD,CAAlB,EAAyB;AACvBC,IAAAA,KAAK,GAAG,IAAIJ,YAAJ,CAAiBI,KAAjB,EAAwBD,GAAxB,CAAR;AACA,WAAOC,KAAP;AACD;;AAEDA,EAAAA,KAAK,CAACG,OAAN,GAAgBJ,GAAhB;AACA,SAAOC,KAAP;AACD;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASI,aAAT,CAAwBC,IAAxB,EAA8B;AAC5B,MAAMC,mBAAmB,GAAGD,IAAI,CAACH,IAAL,CAAUK,KAAV,CAAgB,CAAhB,EAAmBF,IAAI,CAACH,IAAL,CAAUM,IAA7B,EAAmCH,IAAI,CAACI,IAAL,CAAUC,IAA7C,CAA5B;AACA,SAAOJ,mBAAP;AACD;;AAEDK,MAAM,CAACC,OAAP;AAAA;;AAGE,qBAAaC,IAAb,EAAmBC,IAAnB,EAAyB;AAAA;;AACvB,+BAAMD,IAAN,EAAYC,IAAZ;AACA,UAAKJ,IAAL,GAAY,UAAZ;AACA,UAAKK,EAAL,GAAU,MAAKD,IAAL,CAAUC,EAAV,IAAgB,WAA1B;AACA,UAAKC,KAAL,GAAa,WAAb;AAEA,UAAKC,aAAL,GAAqB;AACnBC,MAAAA,OAAO,EAAE;AACPC,QAAAA,QAAQ,EAAE;AADH;AADU,KAArB,CANuB,CAYvB;;AACA,QAAMC,cAAc,GAAG;AACrBC,MAAAA,QAAQ,EAAE,IADW;AAErBC,MAAAA,SAAS,EAAE,SAFU;AAGrBC,MAAAA,MAAM,EAAE,MAHa;AAIrBC,MAAAA,UAAU,EAAE,IAJS;AAKrBC,MAAAA,oBAAoB,EAAE,KALD;AAMrBC,MAAAA,MAAM,EAAE,KANa;AAOrBC,MAAAA,OAAO,EAAE,EAPY;AAQrBC,MAAAA,OAAO,EAAE,KAAK,IARO;AASrBC,MAAAA,KAAK,EAAE,CATc;AAUrBC,MAAAA,eAAe,EAAE,KAVI;AAWrBC,MAAAA,YAAY,EAAE,EAXO;;AAYrB;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACMC,MAAAA,eAtBqB,2BAsBJC,YAtBI,EAsBUC,QAtBV,EAsBoB;AACvC,YAAIC,cAAc,GAAG,EAArB;;AACA,YAAI;AACFA,UAAAA,cAAc,GAAGC,IAAI,CAACC,KAAL,CAAWJ,YAAX,CAAjB;AACD,SAFD,CAEE,OAAOK,GAAP,EAAY;AACZC,UAAAA,OAAO,CAACC,GAAR,CAAYF,GAAZ;AACD;;AAED,eAAOH,cAAP;AACD,OA/BoB;;AAgCrB;AACN;AACA;AACA;AACA;AACMM,MAAAA,gBArCqB,4BAqCHR,YArCG,EAqCWC,QArCX,EAqCqB;AACxC,YAAIlC,KAAK,GAAG,IAAIC,KAAJ,CAAU,cAAV,CAAZ;;AAEA,YAAIJ,cAAc,CAACqC,QAAD,CAAlB,EAA8B;AAC5BlC,UAAAA,KAAK,GAAG,IAAIJ,YAAJ,CAAiBI,KAAjB,EAAwBkC,QAAxB,CAAR;AACD;;AAED,eAAOlC,KAAP;AACD,OA7CoB;;AA8CrB;AACN;AACA;AACA;AACA;AACA;AACA;AACM0C,MAAAA,cArDqB,0BAqDLC,MArDK,EAqDGV,YArDH,EAqDiBC,QArDjB,EAqD2B;AAC9C,eAAOS,MAAM,IAAI,GAAV,IAAiBA,MAAM,GAAG,GAAjC;AACD;AAvDoB,KAAvB;AA0DA,UAAK7B,IAAL,gBAAiBM,cAAjB,EAAoCN,IAApC;;AAEA,UAAK8B,QAAL;;AAEA,UAAKC,YAAL,GAAoB,MAAKA,YAAL,CAAkBC,IAAlB,+BAApB,CA3EuB,CA6EvB;AACA;;AACA,QAAI,MAAKhC,IAAL,CAAUiC,OAAV,YAA6BpD,gBAAjC,EAAmD;AACjD,YAAKqD,QAAL,GAAgB,MAAKlC,IAAL,CAAUiC,OAA1B;AACD,KAFD,MAEO;AACL,YAAKC,QAAL,GAAgB,IAAIrD,gBAAJ,CAAqB,MAAKmB,IAAL,CAAUe,KAA/B,CAAhB;AACD;;AAED,QAAI,MAAKf,IAAL,CAAUY,MAAV,IAAoB,CAAC,MAAKZ,IAAL,CAAUO,QAAnC,EAA6C;AAC3C,YAAM,IAAIpB,KAAJ,CAAU,6DAAV,CAAN;AACD;;AAED,UAAKgD,cAAL,GAAsBC,MAAM,CAACC,MAAP,CAAc,IAAd,CAAtB;AAzFuB;AA0FxB;;AA7FH;;AAAA,SA+FEC,UA/FF,GA+FE,oBAAYC,OAAZ,EAAqB;AACnB,sBAAMD,UAAN,YAAiBC,OAAjB;;AACA,SAAKT,QAAL;AACD,GAlGH;;AAAA,SAoGEA,QApGF,GAoGE,oBAAY;AACV,SAAKU,UAAL,GAAkB,IAAIpE,UAAJ,CAAe,CAAC,KAAK+B,aAAN,EAAqB,KAAKJ,IAAL,CAAU0C,MAA/B,EAAuC,KAAKzC,IAAL,CAAUyC,MAAjD,CAAf,CAAlB;AACA,SAAKC,IAAL,GAAY,KAAKF,UAAL,CAAgBG,SAAhB,CAA0BX,IAA1B,CAA+B,KAAKQ,UAApC,CAAZ;AACA,SAAKI,cAAL,GAHU,CAGY;AACvB,GAxGH;;AAAA,SA0GEC,UA1GF,GA0GE,oBAAYtD,IAAZ,EAAkB;AAChB,QAAMuD,SAAS,GAAG,KAAK/C,IAAL,CAAUgD,QAAV,GAAqBC,SAAvC;;AACA,QAAMhD,IAAI,gBACL,KAAKA,IADA,EAEJ8C,SAAS,IAAI,EAFT,EAGJvD,IAAI,CAACyD,SAAL,IAAkB,EAHd;AAIRnC,MAAAA,OAAO,EAAE;AAJD,MAAV;;AAMA,aAAcb,IAAI,CAACa,OAAnB,EAA4B,KAAKb,IAAL,CAAUa,OAAtC;;AACA,QAAIiC,SAAJ,EAAe;AACb,eAAc9C,IAAI,CAACa,OAAnB,EAA4BiC,SAAS,CAACjC,OAAtC;AACD;;AACD,QAAItB,IAAI,CAACyD,SAAT,EAAoB;AAClB,eAAchD,IAAI,CAACa,OAAnB,EAA4BtB,IAAI,CAACyD,SAAL,CAAenC,OAA3C;AACD;;AAED,WAAOb,IAAP;AACD,GA3HH;;AAAA,SA6HEiD,WA7HF,GA6HE,qBAAa1C,QAAb,EAAuBZ,IAAvB,EAA6BK,IAA7B,EAAmC;AACjC,QAAMU,UAAU,GAAGwC,KAAK,CAACC,OAAN,CAAcnD,IAAI,CAACU,UAAnB,IACfV,IAAI,CAACU,UADU,CAEjB;AAFiB,MAGf0B,MAAM,CAACgB,IAAP,CAAYzD,IAAZ,CAHJ;AAIAe,IAAAA,UAAU,CAAC2C,OAAX,CAAmB,UAACC,IAAD,EAAU;AAC3B/C,MAAAA,QAAQ,CAACgD,MAAT,CAAgBD,IAAhB,EAAsB3D,IAAI,CAAC2D,IAAD,CAA1B;AACD,KAFD;AAGD,GArIH;;AAAA,SAuIEE,oBAvIF,GAuIE,8BAAsBjE,IAAtB,EAA4BS,IAA5B,EAAkC;AAChC,QAAMyD,QAAQ,GAAG,IAAIC,QAAJ,EAAjB;AAEA,SAAKT,WAAL,CAAiBQ,QAAjB,EAA2BlE,IAAI,CAACI,IAAhC,EAAsCK,IAAtC;AAEA,QAAMR,mBAAmB,GAAGF,aAAa,CAACC,IAAD,CAAzC;;AAEA,QAAIA,IAAI,CAACoE,IAAT,EAAe;AACbF,MAAAA,QAAQ,CAACF,MAAT,CAAgBvD,IAAI,CAACQ,SAArB,EAAgChB,mBAAhC,EAAqDD,IAAI,CAACI,IAAL,CAAUgE,IAA/D;AACD,KAFD,MAEO;AACLF,MAAAA,QAAQ,CAACF,MAAT,CAAgBvD,IAAI,CAACQ,SAArB,EAAgChB,mBAAhC;AACD;;AAED,WAAOiE,QAAP;AACD,GArJH;;AAAA,SAuJEG,mBAvJF,GAuJE,6BAAqBC,KAArB,EAA4B7D,IAA5B,EAAkC;AAAA;;AAChC,QAAMyD,QAAQ,GAAG,IAAIC,QAAJ,EAAjB;;AADgC,8BAGf,KAAK3D,IAAL,CAAUgD,QAAV,EAHe;AAAA,QAGxBpD,IAHwB,uBAGxBA,IAHwB;;AAIhC,SAAKsD,WAAL,CAAiBQ,QAAjB,EAA2B9D,IAA3B,EAAiCK,IAAjC;AAEA6D,IAAAA,KAAK,CAACR,OAAN,CAAc,UAAC9D,IAAD,EAAU;AACtB,UAAMS,IAAI,GAAG,MAAI,CAAC6C,UAAL,CAAgBtD,IAAhB,CAAb;;AAEA,UAAMC,mBAAmB,GAAGF,aAAa,CAACC,IAAD,CAAzC;;AAEA,UAAIA,IAAI,CAACoE,IAAT,EAAe;AACbF,QAAAA,QAAQ,CAACF,MAAT,CAAgBvD,IAAI,CAACQ,SAArB,EAAgChB,mBAAhC,EAAqDD,IAAI,CAACoE,IAA1D;AACD,OAFD,MAEO;AACLF,QAAAA,QAAQ,CAACF,MAAT,CAAgBvD,IAAI,CAACQ,SAArB,EAAgChB,mBAAhC;AACD;AACF,KAVD;AAYA,WAAOiE,QAAP;AACD,GA1KH;;AAAA,SA4KEK,gBA5KF,GA4KE,0BAAkBvE,IAAlB,EAAwBS,IAAxB,EAA8B;AAC5B,WAAOT,IAAI,CAACH,IAAZ;AACD,GA9KH;;AAAA,SAgLE2E,MAhLF,GAgLE,gBAAQxE,IAAR,EAAcyE,OAAd,EAAuBC,KAAvB,EAA8B;AAAA;;AAC5B,QAAMjE,IAAI,GAAG,KAAK6C,UAAL,CAAgBtD,IAAhB,CAAb;AAEA,SAAKQ,IAAL,CAAU2B,GAAV,gBAA2BsC,OAA3B,YAAyCC,KAAzC;AACA,WAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,MAAA,MAAI,CAACrE,IAAL,CAAUsE,IAAV,CAAe,gBAAf,EAAiC9E,IAAjC;;AAEA,UAAMH,IAAI,GAAGY,IAAI,CAACO,QAAL,GACT,MAAI,CAACiD,oBAAL,CAA0BjE,IAA1B,EAAgCS,IAAhC,CADS,GAET,MAAI,CAAC8D,gBAAL,CAAsBvE,IAAtB,EAA4BS,IAA5B,CAFJ;AAIA,UAAMf,GAAG,GAAG,IAAIqF,cAAJ,EAAZ;AACA,MAAA,MAAI,CAACnC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,IAA+B,IAAItB,YAAJ,CAAiB,MAAI,CAACoB,IAAtB,CAA/B;AAEA,UAAMwE,KAAK,GAAG,IAAI3F,eAAJ,CAAoBoB,IAAI,CAACc,OAAzB,EAAkC,YAAM;AACpD7B,QAAAA,GAAG,CAACuF,KAAJ;AACAC,QAAAA,aAAa,CAACC,IAAd;AACA,YAAMxF,KAAK,GAAG,IAAIC,KAAJ,CAAU,MAAI,CAACuD,IAAL,CAAU,UAAV,EAAsB;AAAEiC,UAAAA,OAAO,EAAEC,IAAI,CAACC,IAAL,CAAU7E,IAAI,CAACc,OAAL,GAAe,IAAzB;AAAX,SAAtB,CAAV,CAAd;;AACA,QAAA,MAAI,CAACf,IAAL,CAAUsE,IAAV,CAAe,cAAf,EAA+B9E,IAA/B,EAAqCL,KAArC;;AACAkF,QAAAA,MAAM,CAAClF,KAAD,CAAN;AACD,OANa,CAAd;AAQA,UAAMe,EAAE,GAAG9B,IAAI,EAAf;AAEAc,MAAAA,GAAG,CAAC8E,MAAJ,CAAWe,gBAAX,CAA4B,WAA5B,EAAyC,UAACC,EAAD,EAAQ;AAC/C,QAAA,MAAI,CAAChF,IAAL,CAAU2B,GAAV,kBAA6BzB,EAA7B;AACD,OAFD;AAIAhB,MAAAA,GAAG,CAAC8E,MAAJ,CAAWe,gBAAX,CAA4B,UAA5B,EAAwC,UAACC,EAAD,EAAQ;AAC9C,QAAA,MAAI,CAAChF,IAAL,CAAU2B,GAAV,kBAA6BzB,EAA7B,mBAA6C8E,EAAE,CAACC,MAAhD,WAA4DD,EAAE,CAACd,KAA/D,EAD8C,CAE9C;AACA;;;AACAM,QAAAA,KAAK,CAACU,QAAN;;AAEA,YAAIF,EAAE,CAACG,gBAAP,EAAyB;AACvB,UAAA,MAAI,CAACnF,IAAL,CAAUsE,IAAV,CAAe,iBAAf,EAAkC9E,IAAlC,EAAwC;AACtC4F,YAAAA,QAAQ,EAAE,MAD4B;AAEtCC,YAAAA,aAAa,EAAEL,EAAE,CAACC,MAFoB;AAGtCK,YAAAA,UAAU,EAAEN,EAAE,CAACd;AAHuB,WAAxC;AAKD;AACF,OAbD;AAeAhF,MAAAA,GAAG,CAAC6F,gBAAJ,CAAqB,MAArB,EAA6B,UAACC,EAAD,EAAQ;AACnC,QAAA,MAAI,CAAChF,IAAL,CAAU2B,GAAV,kBAA6BzB,EAA7B;;AACAsE,QAAAA,KAAK,CAACG,IAAN;AACAD,QAAAA,aAAa,CAACC,IAAd;;AACA,YAAI,MAAI,CAACvC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,CAAJ,EAAkC;AAChC,UAAA,MAAI,CAACkC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,EAA6BqF,MAA7B;;AACA,UAAA,MAAI,CAACnD,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,IAA+B,IAA/B;AACD;;AAED,YAAID,IAAI,CAAC4B,cAAL,CAAoBmD,EAAE,CAACQ,MAAH,CAAU1D,MAA9B,EAAsC5C,GAAG,CAACkC,YAA1C,EAAwDlC,GAAxD,CAAJ,EAAkE;AAChE,cAAMuG,IAAI,GAAGxF,IAAI,CAACkB,eAAL,CAAqBjC,GAAG,CAACkC,YAAzB,EAAuClC,GAAvC,CAAb;AACA,cAAMwG,SAAS,GAAGD,IAAI,CAACxF,IAAI,CAACW,oBAAN,CAAtB;AAEA,cAAM+E,UAAU,GAAG;AACjB7D,YAAAA,MAAM,EAAEkD,EAAE,CAACQ,MAAH,CAAU1D,MADD;AAEjB2D,YAAAA,IAAI,EAAJA,IAFiB;AAGjBC,YAAAA,SAAS,EAATA;AAHiB,WAAnB;;AAMA,UAAA,MAAI,CAAC1F,IAAL,CAAUsE,IAAV,CAAe,gBAAf,EAAiC9E,IAAjC,EAAuCmG,UAAvC;;AAEA,cAAID,SAAJ,EAAe;AACb,YAAA,MAAI,CAAC1F,IAAL,CAAU2B,GAAV,eAA0BnC,IAAI,CAACoE,IAA/B,cAA4C8B,SAA5C;AACD;;AAED,iBAAOtB,OAAO,CAAC5E,IAAD,CAAd;AACD,SAjBD,MAiBO;AACL,cAAMiG,KAAI,GAAGxF,IAAI,CAACkB,eAAL,CAAqBjC,GAAG,CAACkC,YAAzB,EAAuClC,GAAvC,CAAb;;AACA,cAAMC,KAAK,GAAGF,kBAAkB,CAACC,GAAD,EAAMe,IAAI,CAAC2B,gBAAL,CAAsB1C,GAAG,CAACkC,YAA1B,EAAwClC,GAAxC,CAAN,CAAhC;AAEA,cAAMmC,QAAQ,GAAG;AACfS,YAAAA,MAAM,EAAEkD,EAAE,CAACQ,MAAH,CAAU1D,MADH;AAEf2D,YAAAA,IAAI,EAAJA;AAFe,WAAjB;;AAKA,UAAA,MAAI,CAACzF,IAAL,CAAUsE,IAAV,CAAe,cAAf,EAA+B9E,IAA/B,EAAqCL,KAArC,EAA4CkC,QAA5C;;AACA,iBAAOgD,MAAM,CAAClF,KAAD,CAAb;AACD;AACF,OAtCD;AAwCAD,MAAAA,GAAG,CAAC6F,gBAAJ,CAAqB,OAArB,EAA8B,UAACC,EAAD,EAAQ;AACpC,QAAA,MAAI,CAAChF,IAAL,CAAU2B,GAAV,kBAA6BzB,EAA7B;;AACAsE,QAAAA,KAAK,CAACG,IAAN;AACAD,QAAAA,aAAa,CAACC,IAAd;;AACA,YAAI,MAAI,CAACvC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,CAAJ,EAAkC;AAChC,UAAA,MAAI,CAACkC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,EAA6BqF,MAA7B;;AACA,UAAA,MAAI,CAACnD,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,IAA+B,IAA/B;AACD;;AAED,YAAMf,KAAK,GAAGF,kBAAkB,CAACC,GAAD,EAAMe,IAAI,CAAC2B,gBAAL,CAAsB1C,GAAG,CAACkC,YAA1B,EAAwClC,GAAxC,CAAN,CAAhC;;AACA,QAAA,MAAI,CAACc,IAAL,CAAUsE,IAAV,CAAe,cAAf,EAA+B9E,IAA/B,EAAqCL,KAArC;;AACA,eAAOkF,MAAM,CAAClF,KAAD,CAAb;AACD,OAZD;AAcAD,MAAAA,GAAG,CAAC0G,IAAJ,CAAS3F,IAAI,CAACS,MAAL,CAAYmF,WAAZ,EAAT,EAAoC5F,IAAI,CAAC6F,QAAzC,EAAmD,IAAnD,EA7FsC,CA8FtC;AACA;;AACA5G,MAAAA,GAAG,CAAC+B,eAAJ,GAAsBhB,IAAI,CAACgB,eAA3B;;AACA,UAAIhB,IAAI,CAACiB,YAAL,KAAsB,EAA1B,EAA8B;AAC5BhC,QAAAA,GAAG,CAACgC,YAAJ,GAAmBjB,IAAI,CAACiB,YAAxB;AACD;;AAEDmB,MAAAA,MAAM,CAACgB,IAAP,CAAYpD,IAAI,CAACa,OAAjB,EAA0BwC,OAA1B,CAAkC,UAACyC,MAAD,EAAY;AAC5C7G,QAAAA,GAAG,CAAC8G,gBAAJ,CAAqBD,MAArB,EAA6B9F,IAAI,CAACa,OAAL,CAAaiF,MAAb,CAA7B;AACD,OAFD;;AAIA,UAAMrB,aAAa,GAAG,MAAI,CAACvC,QAAL,CAAc8D,GAAd,CAAkB,YAAM;AAC5C/G,QAAAA,GAAG,CAACgH,IAAJ,CAAS7G,IAAT;AACA,eAAO,YAAM;AACXmF,UAAAA,KAAK,CAACG,IAAN;AACAzF,UAAAA,GAAG,CAACuF,KAAJ;AACD,SAHD;AAID,OANqB,CAAtB;;AAQA,MAAA,MAAI,CAAC0B,YAAL,CAAkB3G,IAAI,CAACU,EAAvB,EAA2B,YAAM;AAC/BwE,QAAAA,aAAa,CAACD,KAAd;AACAJ,QAAAA,MAAM,CAAC,IAAIjF,KAAJ,CAAU,cAAV,CAAD,CAAN;AACD,OAHD;;AAKA,MAAA,MAAI,CAACgH,WAAL,CAAiB5G,IAAI,CAACU,EAAtB,EAA0B,YAAM;AAC9BwE,QAAAA,aAAa,CAACD,KAAd;AACAJ,QAAAA,MAAM,CAAC,IAAIjF,KAAJ,CAAU,kBAAV,CAAD,CAAN;AACD,OAHD;AAID,KA1HM,CAAP;AA2HD,GA/SH;;AAAA,SAiTEiH,YAjTF,GAiTE,sBAAc7G,IAAd,EAAoByE,OAApB,EAA6BC,KAA7B,EAAoC;AAAA;;AAClC,QAAMjE,IAAI,GAAG,KAAK6C,UAAL,CAAgBtD,IAAhB,CAAb;AACA,WAAO,IAAI2E,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,MAAA,MAAI,CAACrE,IAAL,CAAUsE,IAAV,CAAe,gBAAf,EAAiC9E,IAAjC;;AAEA,UAAM8G,MAAM,GAAG,EAAf;AACA,UAAM3F,UAAU,GAAGwC,KAAK,CAACC,OAAN,CAAcnD,IAAI,CAACU,UAAnB,IACfV,IAAI,CAACU,UADU,CAEjB;AAFiB,QAGf0B,MAAM,CAACgB,IAAP,CAAY7D,IAAI,CAACI,IAAjB,CAHJ;AAKAe,MAAAA,UAAU,CAAC2C,OAAX,CAAmB,UAACM,IAAD,EAAU;AAC3B0C,QAAAA,MAAM,CAAC1C,IAAD,CAAN,GAAepE,IAAI,CAACI,IAAL,CAAUgE,IAAV,CAAf;AACD,OAFD;AAIA,UAAM2C,MAAM,GAAG/G,IAAI,CAACgH,MAAL,CAAYC,eAAZ,CAA4BC,QAA5B,GAAuCpI,QAAvC,GAAkDC,aAAjE;AACA,UAAMoI,MAAM,GAAG,IAAIJ,MAAJ,CAAW,MAAI,CAACvG,IAAhB,EAAsBR,IAAI,CAACgH,MAAL,CAAYC,eAAlC,CAAf;AACAE,MAAAA,MAAM,CAACC,IAAP,CAAYpH,IAAI,CAACgH,MAAL,CAAYK,GAAxB,eACKrH,IAAI,CAACgH,MAAL,CAAYf,IADjB;AAEEK,QAAAA,QAAQ,EAAE7F,IAAI,CAAC6F,QAFjB;AAGEnG,QAAAA,IAAI,EAAEH,IAAI,CAACH,IAAL,CAAUM,IAHlB;AAIEmH,QAAAA,SAAS,EAAE7G,IAAI,CAACQ,SAJlB;AAKEsG,QAAAA,QAAQ,EAAET,MALZ;AAMEU,QAAAA,UAAU,EAAE/G,IAAI,CAACS,MANnB;AAOEuG,QAAAA,WAAW,EAAEhH,IAAI,CAACO,QAPpB;AAQEM,QAAAA,OAAO,EAAEb,IAAI,CAACa;AARhB,UASGoG,IATH,CASQ,UAACC,GAAD,EAAS;AACf,YAAMC,KAAK,GAAGD,GAAG,CAACC,KAAlB;AACA,YAAMC,IAAI,GAAG3I,aAAa,CAACc,IAAI,CAACgH,MAAL,CAAYc,YAAb,CAA1B;AACA,YAAMC,MAAM,GAAG,IAAI/I,MAAJ,CAAW;AAAEgH,UAAAA,MAAM,EAAK6B,IAAL,aAAiBD,KAAzB;AAAkCI,UAAAA,QAAQ,EAAE;AAA5C,SAAX,CAAf;AACA,QAAA,MAAI,CAACpF,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,IAA+B,IAAItB,YAAJ,CAAiB,MAAI,CAACoB,IAAtB,CAA/B;;AAEA,QAAA,MAAI,CAACmG,YAAL,CAAkB3G,IAAI,CAACU,EAAvB,EAA2B,YAAM;AAC/BqH,UAAAA,MAAM,CAACrB,IAAP,CAAY,OAAZ,EAAqB,EAArB;AACAxB,UAAAA,aAAa,CAACD,KAAd;AACAL,UAAAA,OAAO,aAAW5E,IAAI,CAACU,EAAhB,kBAAP;AACD,SAJD;;AAMA,QAAA,MAAI,CAACkG,WAAL,CAAiB5G,IAAI,CAACU,EAAtB,EAA0B,YAAM;AAC9BqH,UAAAA,MAAM,CAACrB,IAAP,CAAY,OAAZ,EAAqB,EAArB;AACAxB,UAAAA,aAAa,CAACD,KAAd;AACAL,UAAAA,OAAO,aAAW5E,IAAI,CAACU,EAAhB,mBAAP;AACD,SAJD;;AAMA,QAAA,MAAI,CAACuH,OAAL,CAAajI,IAAI,CAACU,EAAlB,EAAsB,YAAM;AAC1BqH,UAAAA,MAAM,CAACrB,IAAP,CAAY,OAAZ,EAAqB,EAArB;AACAqB,UAAAA,MAAM,CAACrB,IAAP,CAAY,QAAZ,EAAsB,EAAtB;AACD,SAHD;;AAKA,QAAA,MAAI,CAACwB,UAAL,CAAgBlI,IAAI,CAACU,EAArB,EAAyB,YAAM;AAC7BqH,UAAAA,MAAM,CAACrB,IAAP,CAAY,OAAZ,EAAqB,EAArB;AACAqB,UAAAA,MAAM,CAACrB,IAAP,CAAY,QAAZ,EAAsB,EAAtB;AACD,SAHD;;AAKAqB,QAAAA,MAAM,CAACI,EAAP,CAAU,UAAV,EAAsB,UAACC,YAAD;AAAA,iBAAkBnJ,kBAAkB,CAAC,MAAD,EAAOmJ,YAAP,EAAqBpI,IAArB,CAApC;AAAA,SAAtB;AAEA+H,QAAAA,MAAM,CAACI,EAAP,CAAU,SAAV,EAAqB,UAACtI,IAAD,EAAU;AAC7B,cAAMoG,IAAI,GAAGxF,IAAI,CAACkB,eAAL,CAAqB9B,IAAI,CAACgC,QAAL,CAAcD,YAAnC,EAAiD/B,IAAI,CAACgC,QAAtD,CAAb;AACA,cAAMqE,SAAS,GAAGD,IAAI,CAACxF,IAAI,CAACW,oBAAN,CAAtB;AAEA,cAAM+E,UAAU,GAAG;AACjB7D,YAAAA,MAAM,EAAEzC,IAAI,CAACgC,QAAL,CAAcS,MADL;AAEjB2D,YAAAA,IAAI,EAAJA,IAFiB;AAGjBC,YAAAA,SAAS,EAATA;AAHiB,WAAnB;;AAMA,UAAA,MAAI,CAAC1F,IAAL,CAAUsE,IAAV,CAAe,gBAAf,EAAiC9E,IAAjC,EAAuCmG,UAAvC;;AACAjB,UAAAA,aAAa,CAACC,IAAd;;AACA,cAAI,MAAI,CAACvC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,CAAJ,EAAkC;AAChC,YAAA,MAAI,CAACkC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,EAA6BqF,MAA7B;;AACA,YAAA,MAAI,CAACnD,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,IAA+B,IAA/B;AACD;;AACD,iBAAOkE,OAAO,EAAd;AACD,SAjBD;AAmBAmD,QAAAA,MAAM,CAACI,EAAP,CAAU,OAAV,EAAmB,UAACE,OAAD,EAAa;AAC9B,cAAMC,IAAI,GAAGD,OAAO,CAACxG,QAArB;AACA,cAAMlC,KAAK,GAAG2I,IAAI,GACd7H,IAAI,CAAC2B,gBAAL,CAAsBkG,IAAI,CAAC1G,YAA3B,EAAyC0G,IAAzC,CADc,GAEd,SAAc,IAAI1I,KAAJ,CAAUyI,OAAO,CAAC1I,KAAR,CAAc4I,OAAxB,CAAd,EAAgD;AAAEC,YAAAA,KAAK,EAAEH,OAAO,CAAC1I;AAAjB,WAAhD,CAFJ;;AAGA,UAAA,MAAI,CAACa,IAAL,CAAUsE,IAAV,CAAe,cAAf,EAA+B9E,IAA/B,EAAqCL,KAArC;;AACAuF,UAAAA,aAAa,CAACC,IAAd;;AACA,cAAI,MAAI,CAACvC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,CAAJ,EAAkC;AAChC,YAAA,MAAI,CAACkC,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,EAA6BqF,MAA7B;;AACA,YAAA,MAAI,CAACnD,cAAL,CAAoB5C,IAAI,CAACU,EAAzB,IAA+B,IAA/B;AACD;;AACDmE,UAAAA,MAAM,CAAClF,KAAD,CAAN;AACD,SAZD;;AAcA,YAAMuF,aAAa,GAAG,MAAI,CAACvC,QAAL,CAAc8D,GAAd,CAAkB,YAAM;AAC5CsB,UAAAA,MAAM,CAAC3B,IAAP;;AACA,cAAIpG,IAAI,CAACyI,QAAT,EAAmB;AACjBV,YAAAA,MAAM,CAACrB,IAAP,CAAY,OAAZ,EAAqB,EAArB;AACD;;AAED,iBAAO;AAAA,mBAAMqB,MAAM,CAACW,KAAP,EAAN;AAAA,WAAP;AACD,SAPqB,CAAtB;AAQD,OAhFD,EAgFGC,KAhFH,CAgFS,UAAC1G,GAAD,EAAS;AAChB,QAAA,MAAI,CAACzB,IAAL,CAAUsE,IAAV,CAAe,cAAf,EAA+B9E,IAA/B,EAAqCiC,GAArC;;AACA4C,QAAAA,MAAM,CAAC5C,GAAD,CAAN;AACD,OAnFD;AAoFD,KAnGM,CAAP;AAoGD,GAvZH;;AAAA,SAyZE2G,YAzZF,GAyZE,sBAActE,KAAd,EAAqB;AAAA;;AACnB,WAAO,IAAIK,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,UAAMyB,QAAQ,GAAG,MAAI,CAAC7F,IAAL,CAAU6F,QAA3B;AACA,UAAMpF,MAAM,GAAG,MAAI,CAACT,IAAL,CAAUS,MAAzB;;AAEA,UAAM2H,aAAa,GAAG,MAAI,CAACrI,IAAL,CAAUgD,QAAV,GAAqBC,SAA3C;;AACA,UAAMzC,QAAQ,GAAG,MAAI,CAACqD,mBAAL,CAAyBC,KAAzB,eACZ,MAAI,CAAC7D,IADO,EAEXoI,aAAa,IAAI,EAFN,EAAjB;;AAKA,UAAMnJ,GAAG,GAAG,IAAIqF,cAAJ,EAAZ;AAEA,UAAMC,KAAK,GAAG,IAAI3F,eAAJ,CAAoB,MAAI,CAACoB,IAAL,CAAUc,OAA9B,EAAuC,YAAM;AACzD7B,QAAAA,GAAG,CAACuF,KAAJ;AACA,YAAMtF,KAAK,GAAG,IAAIC,KAAJ,CAAU,MAAI,CAACuD,IAAL,CAAU,UAAV,EAAsB;AAAEiC,UAAAA,OAAO,EAAEC,IAAI,CAACC,IAAL,CAAU,MAAI,CAAC7E,IAAL,CAAUc,OAAV,GAAoB,IAA9B;AAAX,SAAtB,CAAV,CAAd;AACAuH,QAAAA,SAAS,CAACnJ,KAAD,CAAT;AACAkF,QAAAA,MAAM,CAAClF,KAAD,CAAN;AACD,OALa,CAAd;;AAOA,UAAMmJ,SAAS,GAAG,SAAZA,SAAY,CAACnJ,KAAD,EAAW;AAC3B2E,QAAAA,KAAK,CAACR,OAAN,CAAc,UAAC9D,IAAD,EAAU;AACtB,UAAA,MAAI,CAACQ,IAAL,CAAUsE,IAAV,CAAe,cAAf,EAA+B9E,IAA/B,EAAqCL,KAArC;AACD,SAFD;AAGD,OAJD;;AAMAD,MAAAA,GAAG,CAAC8E,MAAJ,CAAWe,gBAAX,CAA4B,WAA5B,EAAyC,UAACC,EAAD,EAAQ;AAC/C,QAAA,MAAI,CAAChF,IAAL,CAAU2B,GAAV,CAAc,sCAAd;;AACA6C,QAAAA,KAAK,CAACU,QAAN;AACD,OAHD;AAKAhG,MAAAA,GAAG,CAAC8E,MAAJ,CAAWe,gBAAX,CAA4B,UAA5B,EAAwC,UAACC,EAAD,EAAQ;AAC9CR,QAAAA,KAAK,CAACU,QAAN;AAEA,YAAI,CAACF,EAAE,CAACG,gBAAR,EAA0B;AAE1BrB,QAAAA,KAAK,CAACR,OAAN,CAAc,UAAC9D,IAAD,EAAU;AACtB,UAAA,MAAI,CAACQ,IAAL,CAAUsE,IAAV,CAAe,iBAAf,EAAkC9E,IAAlC,EAAwC;AACtC4F,YAAAA,QAAQ,EAAE,MAD4B;AAEtCC,YAAAA,aAAa,EAAEL,EAAE,CAACC,MAAH,GAAYD,EAAE,CAACd,KAAf,GAAuB1E,IAAI,CAACG,IAFL;AAGtC2F,YAAAA,UAAU,EAAE9F,IAAI,CAACG;AAHqB,WAAxC;AAKD,SAND;AAOD,OAZD;AAcAT,MAAAA,GAAG,CAAC6F,gBAAJ,CAAqB,MAArB,EAA6B,UAACC,EAAD,EAAQ;AACnCR,QAAAA,KAAK,CAACG,IAAN;;AAEA,YAAI,MAAI,CAAC1E,IAAL,CAAU4B,cAAV,CAAyBmD,EAAE,CAACQ,MAAH,CAAU1D,MAAnC,EAA2C5C,GAAG,CAACkC,YAA/C,EAA6DlC,GAA7D,CAAJ,EAAuE;AACrE,cAAMuG,IAAI,GAAG,MAAI,CAACxF,IAAL,CAAUkB,eAAV,CAA0BjC,GAAG,CAACkC,YAA9B,EAA4ClC,GAA5C,CAAb;;AACA,cAAMyG,UAAU,GAAG;AACjB7D,YAAAA,MAAM,EAAEkD,EAAE,CAACQ,MAAH,CAAU1D,MADD;AAEjB2D,YAAAA,IAAI,EAAJA;AAFiB,WAAnB;AAIA3B,UAAAA,KAAK,CAACR,OAAN,CAAc,UAAC9D,IAAD,EAAU;AACtB,YAAA,MAAI,CAACQ,IAAL,CAAUsE,IAAV,CAAe,gBAAf,EAAiC9E,IAAjC,EAAuCmG,UAAvC;AACD,WAFD;AAGA,iBAAOvB,OAAO,EAAd;AACD;;AAED,YAAMjF,KAAK,GAAG,MAAI,CAACc,IAAL,CAAU2B,gBAAV,CAA2B1C,GAAG,CAACkC,YAA/B,EAA6ClC,GAA7C,KAAqD,IAAIE,KAAJ,CAAU,cAAV,CAAnE;AACAD,QAAAA,KAAK,CAACG,OAAN,GAAgBJ,GAAhB;AACAoJ,QAAAA,SAAS,CAACnJ,KAAD,CAAT;AACA,eAAOkF,MAAM,CAAClF,KAAD,CAAb;AACD,OAnBD;AAqBAD,MAAAA,GAAG,CAAC6F,gBAAJ,CAAqB,OAArB,EAA8B,UAACC,EAAD,EAAQ;AACpCR,QAAAA,KAAK,CAACG,IAAN;AAEA,YAAMxF,KAAK,GAAG,MAAI,CAACc,IAAL,CAAU2B,gBAAV,CAA2B1C,GAAG,CAACkC,YAA/B,EAA6ClC,GAA7C,KAAqD,IAAIE,KAAJ,CAAU,cAAV,CAAnE;AACAkJ,QAAAA,SAAS,CAACnJ,KAAD,CAAT;AACA,eAAOkF,MAAM,CAAClF,KAAD,CAAb;AACD,OAND;;AAQA,MAAA,MAAI,CAACa,IAAL,CAAU2H,EAAV,CAAa,YAAb,EAA2B,YAAM;AAC/BnD,QAAAA,KAAK,CAACG,IAAN;AACAzF,QAAAA,GAAG,CAACuF,KAAJ;AACD,OAHD;;AAKAvF,MAAAA,GAAG,CAAC0G,IAAJ,CAASlF,MAAM,CAACmF,WAAP,EAAT,EAA+BC,QAA/B,EAAyC,IAAzC,EA9EsC,CA+EtC;AACA;;AACA5G,MAAAA,GAAG,CAAC+B,eAAJ,GAAsB,MAAI,CAAChB,IAAL,CAAUgB,eAAhC;;AACA,UAAI,MAAI,CAAChB,IAAL,CAAUiB,YAAV,KAA2B,EAA/B,EAAmC;AACjChC,QAAAA,GAAG,CAACgC,YAAJ,GAAmB,MAAI,CAACjB,IAAL,CAAUiB,YAA7B;AACD;;AAEDmB,MAAAA,MAAM,CAACgB,IAAP,CAAY,MAAI,CAACpD,IAAL,CAAUa,OAAtB,EAA+BwC,OAA/B,CAAuC,UAACyC,MAAD,EAAY;AACjD7G,QAAAA,GAAG,CAAC8G,gBAAJ,CAAqBD,MAArB,EAA6B,MAAI,CAAC9F,IAAL,CAAUa,OAAV,CAAkBiF,MAAlB,CAA7B;AACD,OAFD;AAIA7G,MAAAA,GAAG,CAACgH,IAAJ,CAAS1F,QAAT;AAEAsD,MAAAA,KAAK,CAACR,OAAN,CAAc,UAAC9D,IAAD,EAAU;AACtB,QAAA,MAAI,CAACQ,IAAL,CAAUsE,IAAV,CAAe,gBAAf,EAAiC9E,IAAjC;AACD,OAFD;AAGD,KA/FM,CAAP;AAgGD,GA1fH;;AAAA,SA4fE+I,WA5fF,GA4fE,qBAAazE,KAAb,EAAoB;AAAA;;AAClB,QAAM0E,QAAQ,GAAG1E,KAAK,CAAC2E,GAAN,CAAU,UAACjJ,IAAD,EAAOkJ,CAAP,EAAa;AACtC,UAAMzE,OAAO,GAAG0E,QAAQ,CAACD,CAAD,EAAI,EAAJ,CAAR,GAAkB,CAAlC;AACA,UAAMxE,KAAK,GAAGJ,KAAK,CAAC8E,MAApB;;AAEA,UAAIpJ,IAAI,CAACL,KAAT,EAAgB;AACd,eAAOgF,OAAO,CAACE,MAAR,CAAe,IAAIjF,KAAJ,CAAUI,IAAI,CAACL,KAAf,CAAf,CAAP;AACD,OAFD,MAEO,IAAIK,IAAI,CAACqJ,QAAT,EAAmB;AACxB,eAAO,MAAI,CAACxC,YAAL,CAAkB7G,IAAlB,EAAwByE,OAAxB,EAAiCC,KAAjC,CAAP;AACD,OAFM,MAEA;AACL,eAAO,MAAI,CAACF,MAAL,CAAYxE,IAAZ,EAAkByE,OAAlB,EAA2BC,KAA3B,CAAP;AACD;AACF,KAXgB,CAAjB;AAaA,WAAOvF,MAAM,CAAC6J,QAAD,CAAb;AACD,GA3gBH;;AAAA,SA6gBErC,YA7gBF,GA6gBE,sBAAc2C,MAAd,EAAsBC,EAAtB,EAA0B;AACxB,SAAK3G,cAAL,CAAoB0G,MAApB,EAA4BnB,EAA5B,CAA+B,cAA/B,EAA+C,UAACnI,IAAD,EAAU;AACvD,UAAIsJ,MAAM,KAAKtJ,IAAI,CAACU,EAApB,EAAwB6I,EAAE,CAACvJ,IAAI,CAACU,EAAN,CAAF;AACzB,KAFD;AAGD,GAjhBH;;AAAA,SAmhBEuH,OAnhBF,GAmhBE,iBAASqB,MAAT,EAAiBC,EAAjB,EAAqB;AACnB,SAAK3G,cAAL,CAAoB0G,MAApB,EAA4BnB,EAA5B,CAA+B,cAA/B,EAA+C,UAACqB,YAAD,EAAkB;AAC/D,UAAIF,MAAM,KAAKE,YAAf,EAA6B;AAC3BD,QAAAA,EAAE;AACH;AACF,KAJD;AAKD,GAzhBH;;AAAA,SA2hBErB,UA3hBF,GA2hBE,oBAAYoB,MAAZ,EAAoBC,EAApB,EAAwB;AAAA;;AACtB,SAAK3G,cAAL,CAAoB0G,MAApB,EAA4BnB,EAA5B,CAA+B,WAA/B,EAA4C,UAACsB,YAAD,EAAkB;AAC5D,UAAI,CAAC,MAAI,CAACjJ,IAAL,CAAUkJ,OAAV,CAAkBJ,MAAlB,CAAL,EAAgC;AAChCC,MAAAA,EAAE;AACH,KAHD;AAID,GAhiBH;;AAAA,SAkiBE3C,WAliBF,GAkiBE,qBAAa0C,MAAb,EAAqBC,EAArB,EAAyB;AAAA;;AACvB,SAAK3G,cAAL,CAAoB0G,MAApB,EAA4BnB,EAA5B,CAA+B,YAA/B,EAA6C,YAAM;AACjD,UAAI,CAAC,MAAI,CAAC3H,IAAL,CAAUkJ,OAAV,CAAkBJ,MAAlB,CAAL,EAAgC;AAChCC,MAAAA,EAAE;AACH,KAHD;AAID,GAviBH;;AAAA,SAyiBE/G,YAziBF,GAyiBE,sBAAcmH,OAAd,EAAuB;AAAA;;AACrB,QAAIA,OAAO,CAACP,MAAR,KAAmB,CAAvB,EAA0B;AACxB,WAAK5I,IAAL,CAAU2B,GAAV,CAAc,iCAAd;AACA,aAAOwC,OAAO,CAACC,OAAR,EAAP;AACD,KAJoB,CAMrB;;;AACA,QAAI,KAAKnE,IAAL,CAAUe,KAAV,KAAoB,CAApB,IAAyB,CAAC,KAAKf,IAAL,CAAUiC,OAAxC,EAAiD;AAC/C,WAAKlC,IAAL,CAAU2B,GAAV,CACE,kPADF,EAEE,SAFF;AAID;;AAED,SAAK3B,IAAL,CAAU2B,GAAV,CAAc,0BAAd;AACA,QAAMmC,KAAK,GAAGqF,OAAO,CAACV,GAAR,CAAY,UAACK,MAAD;AAAA,aAAY,MAAI,CAAC9I,IAAL,CAAUkJ,OAAV,CAAkBJ,MAAlB,CAAZ;AAAA,KAAZ,CAAd;;AAEA,QAAI,KAAK7I,IAAL,CAAUY,MAAd,EAAsB;AACpB;AACA,UAAMuI,gBAAgB,GAAGtF,KAAK,CAACuF,IAAN,CAAW,UAAA7J,IAAI;AAAA,eAAIA,IAAI,CAACqJ,QAAT;AAAA,OAAf,CAAzB;;AACA,UAAIO,gBAAJ,EAAsB;AACpB,cAAM,IAAIhK,KAAJ,CAAU,2DAAV,CAAN;AACD;;AAED,aAAO,KAAKgJ,YAAL,CAAkBtE,KAAlB,CAAP;AACD;;AAED,WAAO,KAAKyE,WAAL,CAAiBzE,KAAjB,EAAwBoD,IAAxB,CAA6B;AAAA,aAAM,IAAN;AAAA,KAA7B,CAAP;AACD,GArkBH;;AAAA,SAukBEoC,OAvkBF,GAukBE,mBAAW;AACT,QAAI,KAAKrJ,IAAL,CAAUY,MAAd,EAAsB;AAAA,iCACK,KAAKb,IAAL,CAAUgD,QAAV,EADL;AAAA,UACZuG,YADY,wBACZA,YADY;;AAEpB,WAAKvJ,IAAL,CAAUwJ,QAAV,CAAmB;AACjBD,QAAAA,YAAY,eACPA,YADO;AAEVE,UAAAA,sBAAsB,EAAE;AAFd;AADK,OAAnB;AAMD;;AAED,SAAKzJ,IAAL,CAAU0J,WAAV,CAAsB,KAAK1H,YAA3B;AACD,GAnlBH;;AAAA,SAqlBE2H,SArlBF,GAqlBE,qBAAa;AACX,QAAI,KAAK1J,IAAL,CAAUY,MAAd,EAAsB;AAAA,iCACK,KAAKb,IAAL,CAAUgD,QAAV,EADL;AAAA,UACZuG,YADY,wBACZA,YADY;;AAEpB,WAAKvJ,IAAL,CAAUwJ,QAAV,CAAmB;AACjBD,QAAAA,YAAY,eACPA,YADO;AAEVE,UAAAA,sBAAsB,EAAE;AAFd;AADK,OAAnB;AAMD;;AAED,SAAKzJ,IAAL,CAAU4J,cAAV,CAAyB,KAAK5H,YAA9B;AACD,GAjmBH;;AAAA;AAAA,EAAyC7D,MAAzC,UACS0L,OADT","sourcesContent":["const { Plugin } = require('@uppy/core')\nconst cuid = require('cuid')\nconst Translator = require('@uppy/utils/lib/Translator')\nconst { Provider, RequestClient, Socket } = require('@uppy/companion-client')\nconst emitSocketProgress = require('@uppy/utils/lib/emitSocketProgress')\nconst getSocketHost = require('@uppy/utils/lib/getSocketHost')\nconst settle = require('@uppy/utils/lib/settle')\nconst EventTracker = require('@uppy/utils/lib/EventTracker')\nconst ProgressTimeout = require('@uppy/utils/lib/ProgressTimeout')\nconst RateLimitedQueue = require('@uppy/utils/lib/RateLimitedQueue')\nconst NetworkError = require('@uppy/utils/lib/NetworkError')\nconst isNetworkError = require('@uppy/utils/lib/isNetworkError')\n\nfunction buildResponseError (xhr, error) {\n  // No error message\n  if (!error) error = new Error('Upload error')\n  // Got an error message string\n  if (typeof error === 'string') error = new Error(error)\n  // Got something else\n  if (!(error instanceof Error)) {\n    error = Object.assign(new Error('Upload error'), { data: error })\n  }\n\n  if (isNetworkError(xhr)) {\n    error = new NetworkError(error, xhr)\n    return error\n  }\n\n  error.request = xhr\n  return error\n}\n\n/**\n * Set `data.type` in the blob to `file.meta.type`,\n * because we might have detected a more accurate file type in Uppy\n * https://stackoverflow.com/a/50875615\n *\n * @param {object} file File object with `data`, `size` and `meta` properties\n * @returns {object} blob updated with the new `type` set from `file.meta.type`\n */\nfunction setTypeInBlob (file) {\n  const dataWithUpdatedType = file.data.slice(0, file.data.size, file.meta.type)\n  return dataWithUpdatedType\n}\n\nmodule.exports = class XHRUpload extends Plugin {\n  static VERSION = require('../package.json').version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'XHRUpload'\n    this.title = 'XHRUpload'\n\n    this.defaultLocale = {\n      strings: {\n        timedOut: 'Upload stalled for %{seconds} seconds, aborting.'\n      }\n    }\n\n    // Default options\n    const defaultOptions = {\n      formData: true,\n      fieldName: 'files[]',\n      method: 'post',\n      metaFields: null,\n      responseUrlFieldName: 'url',\n      bundle: false,\n      headers: {},\n      timeout: 30 * 1000,\n      limit: 0,\n      withCredentials: false,\n      responseType: '',\n      /**\n       * @typedef respObj\n       * @property {string} responseText\n       * @property {number} status\n       * @property {string} statusText\n       * @property {object.<string, string>} headers\n       *\n       * @param {string} responseText the response body string\n       * @param {XMLHttpRequest | respObj} response the response object (XHR or similar)\n       */\n      getResponseData (responseText, response) {\n        let parsedResponse = {}\n        try {\n          parsedResponse = JSON.parse(responseText)\n        } catch (err) {\n          console.log(err)\n        }\n\n        return parsedResponse\n      },\n      /**\n       *\n       * @param {string} responseText the response body string\n       * @param {XMLHttpRequest | respObj} response the response object (XHR or similar)\n       */\n      getResponseError (responseText, response) {\n        let error = new Error('Upload error')\n\n        if (isNetworkError(response)) {\n          error = new NetworkError(error, response)\n        }\n\n        return error\n      },\n      /**\n       * Check if the response from the upload endpoint indicates that the upload was successful.\n       *\n       * @param {number} status the response status code\n       * @param {string} responseText the response body string\n       * @param {XMLHttpRequest | respObj} response the response object (XHR or similar)\n       */\n      validateStatus (status, responseText, response) {\n        return status >= 200 && status < 300\n      }\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n\n    this.i18nInit()\n\n    this.handleUpload = this.handleUpload.bind(this)\n\n    // Simultaneous upload limiting is shared across all uploads with this plugin.\n    // __queue is for internal Uppy use only!\n    if (this.opts.__queue instanceof RateLimitedQueue) {\n      this.requests = this.opts.__queue\n    } else {\n      this.requests = new RateLimitedQueue(this.opts.limit)\n    }\n\n    if (this.opts.bundle && !this.opts.formData) {\n      throw new Error('`opts.formData` must be true when `opts.bundle` is enabled.')\n    }\n\n    this.uploaderEvents = Object.create(null)\n  }\n\n  setOptions (newOpts) {\n    super.setOptions(newOpts)\n    this.i18nInit()\n  }\n\n  i18nInit () {\n    this.translator = new Translator([this.defaultLocale, this.uppy.locale, this.opts.locale])\n    this.i18n = this.translator.translate.bind(this.translator)\n    this.setPluginState() // so that UI re-renders and we see the updated locale\n  }\n\n  getOptions (file) {\n    const overrides = this.uppy.getState().xhrUpload\n    const opts = {\n      ...this.opts,\n      ...(overrides || {}),\n      ...(file.xhrUpload || {}),\n      headers: {}\n    }\n    Object.assign(opts.headers, this.opts.headers)\n    if (overrides) {\n      Object.assign(opts.headers, overrides.headers)\n    }\n    if (file.xhrUpload) {\n      Object.assign(opts.headers, file.xhrUpload.headers)\n    }\n\n    return opts\n  }\n\n  addMetadata (formData, meta, opts) {\n    const metaFields = Array.isArray(opts.metaFields)\n      ? opts.metaFields\n      // Send along all fields by default.\n      : Object.keys(meta)\n    metaFields.forEach((item) => {\n      formData.append(item, meta[item])\n    })\n  }\n\n  createFormDataUpload (file, opts) {\n    const formPost = new FormData()\n\n    this.addMetadata(formPost, file.meta, opts)\n\n    const dataWithUpdatedType = setTypeInBlob(file)\n\n    if (file.name) {\n      formPost.append(opts.fieldName, dataWithUpdatedType, file.meta.name)\n    } else {\n      formPost.append(opts.fieldName, dataWithUpdatedType)\n    }\n\n    return formPost\n  }\n\n  createBundledUpload (files, opts) {\n    const formPost = new FormData()\n\n    const { meta } = this.uppy.getState()\n    this.addMetadata(formPost, meta, opts)\n\n    files.forEach((file) => {\n      const opts = this.getOptions(file)\n\n      const dataWithUpdatedType = setTypeInBlob(file)\n\n      if (file.name) {\n        formPost.append(opts.fieldName, dataWithUpdatedType, file.name)\n      } else {\n        formPost.append(opts.fieldName, dataWithUpdatedType)\n      }\n    })\n\n    return formPost\n  }\n\n  createBareUpload (file, opts) {\n    return file.data\n  }\n\n  upload (file, current, total) {\n    const opts = this.getOptions(file)\n\n    this.uppy.log(`uploading ${current} of ${total}`)\n    return new Promise((resolve, reject) => {\n      this.uppy.emit('upload-started', file)\n\n      const data = opts.formData\n        ? this.createFormDataUpload(file, opts)\n        : this.createBareUpload(file, opts)\n\n      const xhr = new XMLHttpRequest()\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      const timer = new ProgressTimeout(opts.timeout, () => {\n        xhr.abort()\n        queuedRequest.done()\n        const error = new Error(this.i18n('timedOut', { seconds: Math.ceil(opts.timeout / 1000) }))\n        this.uppy.emit('upload-error', file, error)\n        reject(error)\n      })\n\n      const id = cuid()\n\n      xhr.upload.addEventListener('loadstart', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} started`)\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} progress: ${ev.loaded} / ${ev.total}`)\n        // Begin checking for timeouts when progress starts, instead of loading,\n        // to avoid timing out requests on browser concurrency queue\n        timer.progress()\n\n        if (ev.lengthComputable) {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: ev.loaded,\n            bytesTotal: ev.total\n          })\n        }\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} finished`)\n        timer.done()\n        queuedRequest.done()\n        if (this.uploaderEvents[file.id]) {\n          this.uploaderEvents[file.id].remove()\n          this.uploaderEvents[file.id] = null\n        }\n\n        if (opts.validateStatus(ev.target.status, xhr.responseText, xhr)) {\n          const body = opts.getResponseData(xhr.responseText, xhr)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const uploadResp = {\n            status: ev.target.status,\n            body,\n            uploadURL\n          }\n\n          this.uppy.emit('upload-success', file, uploadResp)\n\n          if (uploadURL) {\n            this.uppy.log(`Download ${file.name} from ${uploadURL}`)\n          }\n\n          return resolve(file)\n        } else {\n          const body = opts.getResponseData(xhr.responseText, xhr)\n          const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n\n          const response = {\n            status: ev.target.status,\n            body\n          }\n\n          this.uppy.emit('upload-error', file, error, response)\n          return reject(error)\n        }\n      })\n\n      xhr.addEventListener('error', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} errored`)\n        timer.done()\n        queuedRequest.done()\n        if (this.uploaderEvents[file.id]) {\n          this.uploaderEvents[file.id].remove()\n          this.uploaderEvents[file.id] = null\n        }\n\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n        this.uppy.emit('upload-error', file, error)\n        return reject(error)\n      })\n\n      xhr.open(opts.method.toUpperCase(), opts.endpoint, true)\n      // IE10 does not allow setting `withCredentials` and `responseType`\n      // before `open()` is called.\n      xhr.withCredentials = opts.withCredentials\n      if (opts.responseType !== '') {\n        xhr.responseType = opts.responseType\n      }\n\n      Object.keys(opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, opts.headers[header])\n      })\n\n      const queuedRequest = this.requests.run(() => {\n        xhr.send(data)\n        return () => {\n          timer.done()\n          xhr.abort()\n        }\n      })\n\n      this.onFileRemove(file.id, () => {\n        queuedRequest.abort()\n        reject(new Error('File removed'))\n      })\n\n      this.onCancelAll(file.id, () => {\n        queuedRequest.abort()\n        reject(new Error('Upload cancelled'))\n      })\n    })\n  }\n\n  uploadRemote (file, current, total) {\n    const opts = this.getOptions(file)\n    return new Promise((resolve, reject) => {\n      this.uppy.emit('upload-started', file)\n\n      const fields = {}\n      const metaFields = Array.isArray(opts.metaFields)\n        ? opts.metaFields\n        // Send along all fields by default.\n        : Object.keys(file.meta)\n\n      metaFields.forEach((name) => {\n        fields[name] = file.meta[name]\n      })\n\n      const Client = file.remote.providerOptions.provider ? Provider : RequestClient\n      const client = new Client(this.uppy, file.remote.providerOptions)\n      client.post(file.remote.url, {\n        ...file.remote.body,\n        endpoint: opts.endpoint,\n        size: file.data.size,\n        fieldname: opts.fieldName,\n        metadata: fields,\n        httpMethod: opts.method,\n        useFormData: opts.formData,\n        headers: opts.headers\n      }).then((res) => {\n        const token = res.token\n        const host = getSocketHost(file.remote.companionUrl)\n        const socket = new Socket({ target: `${host}/api/${token}`, autoOpen: false })\n        this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n        this.onFileRemove(file.id, () => {\n          socket.send('pause', {})\n          queuedRequest.abort()\n          resolve(`upload ${file.id} was removed`)\n        })\n\n        this.onCancelAll(file.id, () => {\n          socket.send('pause', {})\n          queuedRequest.abort()\n          resolve(`upload ${file.id} was canceled`)\n        })\n\n        this.onRetry(file.id, () => {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        })\n\n        this.onRetryAll(file.id, () => {\n          socket.send('pause', {})\n          socket.send('resume', {})\n        })\n\n        socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n        socket.on('success', (data) => {\n          const body = opts.getResponseData(data.response.responseText, data.response)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const uploadResp = {\n            status: data.response.status,\n            body,\n            uploadURL\n          }\n\n          this.uppy.emit('upload-success', file, uploadResp)\n          queuedRequest.done()\n          if (this.uploaderEvents[file.id]) {\n            this.uploaderEvents[file.id].remove()\n            this.uploaderEvents[file.id] = null\n          }\n          return resolve()\n        })\n\n        socket.on('error', (errData) => {\n          const resp = errData.response\n          const error = resp\n            ? opts.getResponseError(resp.responseText, resp)\n            : Object.assign(new Error(errData.error.message), { cause: errData.error })\n          this.uppy.emit('upload-error', file, error)\n          queuedRequest.done()\n          if (this.uploaderEvents[file.id]) {\n            this.uploaderEvents[file.id].remove()\n            this.uploaderEvents[file.id] = null\n          }\n          reject(error)\n        })\n\n        const queuedRequest = this.requests.run(() => {\n          socket.open()\n          if (file.isPaused) {\n            socket.send('pause', {})\n          }\n\n          return () => socket.close()\n        })\n      }).catch((err) => {\n        this.uppy.emit('upload-error', file, err)\n        reject(err)\n      })\n    })\n  }\n\n  uploadBundle (files) {\n    return new Promise((resolve, reject) => {\n      const endpoint = this.opts.endpoint\n      const method = this.opts.method\n\n      const optsFromState = this.uppy.getState().xhrUpload\n      const formData = this.createBundledUpload(files, {\n        ...this.opts,\n        ...(optsFromState || {})\n      })\n\n      const xhr = new XMLHttpRequest()\n\n      const timer = new ProgressTimeout(this.opts.timeout, () => {\n        xhr.abort()\n        const error = new Error(this.i18n('timedOut', { seconds: Math.ceil(this.opts.timeout / 1000) }))\n        emitError(error)\n        reject(error)\n      })\n\n      const emitError = (error) => {\n        files.forEach((file) => {\n          this.uppy.emit('upload-error', file, error)\n        })\n      }\n\n      xhr.upload.addEventListener('loadstart', (ev) => {\n        this.uppy.log('[XHRUpload] started uploading bundle')\n        timer.progress()\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        timer.progress()\n\n        if (!ev.lengthComputable) return\n\n        files.forEach((file) => {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: ev.loaded / ev.total * file.size,\n            bytesTotal: file.size\n          })\n        })\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        timer.done()\n\n        if (this.opts.validateStatus(ev.target.status, xhr.responseText, xhr)) {\n          const body = this.opts.getResponseData(xhr.responseText, xhr)\n          const uploadResp = {\n            status: ev.target.status,\n            body\n          }\n          files.forEach((file) => {\n            this.uppy.emit('upload-success', file, uploadResp)\n          })\n          return resolve()\n        }\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        error.request = xhr\n        emitError(error)\n        return reject(error)\n      })\n\n      xhr.addEventListener('error', (ev) => {\n        timer.done()\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        emitError(error)\n        return reject(error)\n      })\n\n      this.uppy.on('cancel-all', () => {\n        timer.done()\n        xhr.abort()\n      })\n\n      xhr.open(method.toUpperCase(), endpoint, true)\n      // IE10 does not allow setting `withCredentials` and `responseType`\n      // before `open()` is called.\n      xhr.withCredentials = this.opts.withCredentials\n      if (this.opts.responseType !== '') {\n        xhr.responseType = this.opts.responseType\n      }\n\n      Object.keys(this.opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, this.opts.headers[header])\n      })\n\n      xhr.send(formData)\n\n      files.forEach((file) => {\n        this.uppy.emit('upload-started', file)\n      })\n    })\n  }\n\n  uploadFiles (files) {\n    const promises = files.map((file, i) => {\n      const current = parseInt(i, 10) + 1\n      const total = files.length\n\n      if (file.error) {\n        return Promise.reject(new Error(file.error))\n      } else if (file.isRemote) {\n        return this.uploadRemote(file, current, total)\n      } else {\n        return this.upload(file, current, total)\n      }\n    })\n\n    return settle(promises)\n  }\n\n  onFileRemove (fileID, cb) {\n    this.uploaderEvents[fileID].on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  onRetry (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-retry', (targetFileID) => {\n      if (fileID === targetFileID) {\n        cb()\n      }\n    })\n  }\n\n  onRetryAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('retry-all', (filesToRetry) => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onCancelAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('cancel-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  handleUpload (fileIDs) {\n    if (fileIDs.length === 0) {\n      this.uppy.log('[XHRUpload] No files to upload!')\n      return Promise.resolve()\n    }\n\n    // no limit configured by the user, and no RateLimitedQueue passed in by a \"parent\" plugin (basically just AwsS3) using the top secret `__queue` option\n    if (this.opts.limit === 0 && !this.opts.__queue) {\n      this.uppy.log(\n        '[XHRUpload] When uploading multiple files at once, consider setting the `limit` option (to `10` for example), to limit the number of concurrent uploads, which helps prevent memory and network issues: https://uppy.io/docs/xhr-upload/#limit-0',\n        'warning'\n      )\n    }\n\n    this.uppy.log('[XHRUpload] Uploading...')\n    const files = fileIDs.map((fileID) => this.uppy.getFile(fileID))\n\n    if (this.opts.bundle) {\n      // if bundle: true, we don’t support remote uploads\n      const isSomeFileRemote = files.some(file => file.isRemote)\n      if (isSomeFileRemote) {\n        throw new Error('Can’t upload remote files when bundle: true option is set')\n      }\n\n      return this.uploadBundle(files)\n    }\n\n    return this.uploadFiles(files).then(() => null)\n  }\n\n  install () {\n    if (this.opts.bundle) {\n      const { capabilities } = this.uppy.getState()\n      this.uppy.setState({\n        capabilities: {\n          ...capabilities,\n          individualCancellation: false\n        }\n      })\n    }\n\n    this.uppy.addUploader(this.handleUpload)\n  }\n\n  uninstall () {\n    if (this.opts.bundle) {\n      const { capabilities } = this.uppy.getState()\n      this.uppy.setState({\n        capabilities: {\n          ...capabilities,\n          individualCancellation: true\n        }\n      })\n    }\n\n    this.uppy.removeUploader(this.handleUpload)\n  }\n}\n"]}